'use strict';

// recommender
var _ = require('lodash');
var request = require('request-promise');
var auth = require('./auth');

var rec = {};

rec.getRange = function getRange(name, num) {
  var ans = {};
  ans['target_' + name] = num;
  return ans;
};

rec.convert = function convert(conf) {
  var raw = Object.keys(conf).map(function (key) {
    return rec.getRange(key, conf[key]);
  }).reduce(function (a, b) {
    return _.merge(a, b);
  });

  if (raw.target_popularity) {
    raw.target_popularity = Math.ceil(raw.target_popularity);
  }
  return raw;
};

rec.takeRandom = function takeRandom(items, num) {
  return _.take(_.sortBy(items, function () {
    return 0.5 - Math.random();
  }), num);
};

rec.formatList = function formatList(list, num) {
  return rec.takeRandom(list, num).join(',');
};

rec.getSongs = function getSongs(conf, artists) {
  var token;
  return auth.getToken().then(function (token) {
    var qs = _.merge(rec.convert(conf), { seed_artists: rec.formatList(artists, 5) });
    return auth.callSpotify({
      url: 'https://api.spotify.com/v1/recommendations',
      json: true,
      qs: qs
    }, token);
  }).catch(function (err) {
    return console.log(err);
  });
};

module.exports = rec;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWNvbW1lbmRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxJQUFJLElBQUksUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJLFVBQVUsUUFBUSxpQkFBUixDQUFkO0FBQ0EsSUFBSSxPQUFPLFFBQVEsUUFBUixDQUFYOztBQUVBLElBQU0sTUFBTSxFQUFaOztBQUVBLElBQUksUUFBSixHQUFlLFNBQVMsUUFBVCxDQUFtQixJQUFuQixFQUF5QixHQUF6QixFQUE4QjtBQUMzQyxNQUFJLE1BQU0sRUFBVjtBQUNBLE1BQUksWUFBWSxJQUFoQixJQUF3QixHQUF4QjtBQUNBLFNBQU8sR0FBUDtBQUNELENBSkQ7O0FBTUEsSUFBSSxPQUFKLEdBQWMsU0FBUyxPQUFULENBQWtCLElBQWxCLEVBQXdCO0FBQ3BDLE1BQUksTUFBTSxPQUFPLElBQVAsQ0FBWSxJQUFaLEVBQ1AsR0FETyxDQUNIO0FBQUEsV0FBTyxJQUFJLFFBQUosQ0FBYSxHQUFiLEVBQWtCLEtBQUssR0FBTCxDQUFsQixDQUFQO0FBQUEsR0FERyxFQUVQLE1BRk8sQ0FFQSxVQUFDLENBQUQsRUFBRyxDQUFIO0FBQUEsV0FBUyxFQUFFLEtBQUYsQ0FBUSxDQUFSLEVBQVUsQ0FBVixDQUFUO0FBQUEsR0FGQSxDQUFWOztBQUlBLE1BQUksSUFBSSxpQkFBUixFQUEyQjtBQUN6QixRQUFJLGlCQUFKLEdBQXdCLEtBQUssSUFBTCxDQUFVLElBQUksaUJBQWQsQ0FBeEI7QUFDRDtBQUNELFNBQU8sR0FBUDtBQUNELENBVEQ7O0FBV0EsSUFBSSxVQUFKLEdBQWlCLFNBQVMsVUFBVCxDQUFxQixLQUFyQixFQUE0QixHQUE1QixFQUFpQztBQUNoRCxTQUFPLEVBQUUsSUFBRixDQUFPLEVBQUUsTUFBRixDQUFTLEtBQVQsRUFBZ0I7QUFBQSxXQUFNLE1BQU0sS0FBSyxNQUFMLEVBQVo7QUFBQSxHQUFoQixDQUFQLEVBQW1ELEdBQW5ELENBQVA7QUFDRCxDQUZEOztBQUlBLElBQUksVUFBSixHQUFpQixTQUFTLFVBQVQsQ0FBcUIsSUFBckIsRUFBMkIsR0FBM0IsRUFBZ0M7QUFDL0MsU0FBTyxJQUFJLFVBQUosQ0FBZSxJQUFmLEVBQXFCLEdBQXJCLEVBQTBCLElBQTFCLENBQStCLEdBQS9CLENBQVA7QUFDRCxDQUZEOztBQUlBLElBQUksUUFBSixHQUFlLFNBQVMsUUFBVCxDQUFtQixJQUFuQixFQUF5QixPQUF6QixFQUFrQztBQUMvQyxNQUFJLEtBQUo7QUFDQSxTQUFPLEtBQ0osUUFESSxHQUVKLElBRkksQ0FFQyxpQkFBUztBQUNiLFFBQUksS0FBSyxFQUFFLEtBQUYsQ0FBUSxJQUFJLE9BQUosQ0FBWSxJQUFaLENBQVIsRUFBMkIsRUFBRSxjQUFjLElBQUksVUFBSixDQUFlLE9BQWYsRUFBd0IsQ0FBeEIsQ0FBaEIsRUFBM0IsQ0FBVDtBQUNBLFdBQU8sS0FBSyxXQUFMLENBQWlCO0FBQ3RCLFdBQUssNENBRGlCO0FBRXRCLFlBQU0sSUFGZ0I7QUFHdEIsVUFBSTtBQUhrQixLQUFqQixFQUlKLEtBSkksQ0FBUDtBQUtELEdBVEksRUFVSixLQVZJLENBVUU7QUFBQSxXQUFPLFFBQVEsR0FBUixDQUFZLEdBQVosQ0FBUDtBQUFBLEdBVkYsQ0FBUDtBQVdELENBYkQ7O0FBZUEsT0FBTyxPQUFQLEdBQWlCLEdBQWpCIiwiZmlsZSI6InJlY29tbWVuZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gcmVjb21tZW5kZXJcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZScpO1xudmFyIGF1dGggPSByZXF1aXJlKCcuL2F1dGgnKTtcblxuY29uc3QgcmVjID0ge307XG5cbnJlYy5nZXRSYW5nZSA9IGZ1bmN0aW9uIGdldFJhbmdlIChuYW1lLCBudW0pIHtcbiAgdmFyIGFucyA9IHt9O1xuICBhbnNbJ3RhcmdldF8nICsgbmFtZV0gPSBudW07XG4gIHJldHVybiBhbnM7XG59O1xuXG5yZWMuY29udmVydCA9IGZ1bmN0aW9uIGNvbnZlcnQgKGNvbmYpIHtcbiAgdmFyIHJhdyA9IE9iamVjdC5rZXlzKGNvbmYpXG4gICAgLm1hcChrZXkgPT4gcmVjLmdldFJhbmdlKGtleSwgY29uZltrZXldKSlcbiAgICAucmVkdWNlKChhLGIpID0+IF8ubWVyZ2UoYSxiKSk7XG5cbiAgaWYgKHJhdy50YXJnZXRfcG9wdWxhcml0eSkge1xuICAgIHJhdy50YXJnZXRfcG9wdWxhcml0eSA9IE1hdGguY2VpbChyYXcudGFyZ2V0X3BvcHVsYXJpdHkpXG4gIH1cbiAgcmV0dXJuIHJhdztcbn07XG5cbnJlYy50YWtlUmFuZG9tID0gZnVuY3Rpb24gdGFrZVJhbmRvbSAoaXRlbXMsIG51bSkge1xuICByZXR1cm4gXy50YWtlKF8uc29ydEJ5KGl0ZW1zLCAoKSA9PiAwLjUgLSBNYXRoLnJhbmRvbSgpKSwgbnVtKVxufTtcblxucmVjLmZvcm1hdExpc3QgPSBmdW5jdGlvbiBmb3JtYXRMaXN0IChsaXN0LCBudW0pIHtcbiAgcmV0dXJuIHJlYy50YWtlUmFuZG9tKGxpc3QsIG51bSkuam9pbignLCcpXG59XG5cbnJlYy5nZXRTb25ncyA9IGZ1bmN0aW9uIGdldFNvbmdzIChjb25mLCBhcnRpc3RzKSB7XG4gIHZhciB0b2tlbjtcbiAgcmV0dXJuIGF1dGhcbiAgICAuZ2V0VG9rZW4oKVxuICAgIC50aGVuKHRva2VuID0+IHtcbiAgICAgIHZhciBxcyA9IF8ubWVyZ2UocmVjLmNvbnZlcnQoY29uZiksIHsgc2VlZF9hcnRpc3RzOiByZWMuZm9ybWF0TGlzdChhcnRpc3RzLCA1KSB9KTtcbiAgICAgIHJldHVybiBhdXRoLmNhbGxTcG90aWZ5KHtcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvcmVjb21tZW5kYXRpb25zJyxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgcXM6IHFzXG4gICAgICB9LCB0b2tlbilcbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coZXJyKSlcbn1cblxubW9kdWxlLmV4cG9ydHMgPSByZWM7XG4iXX0=