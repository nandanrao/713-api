'use strict';

// mood
var mood = {};
var _ = require('lodash');
var firebase = require('./firebase');
var request = require('request-promise');
var Promise = require('bluebird');
var auth = require('./auth');
var recommender = require('./recommender');

mood.handler = function moodHandler(song, userId) {
  return new Promise(function (resolve, reject) {
    var data = {};
    data[userId] = song.songId;
    firebase.child('moodsongs').update(data, function (err) {
      if (err) reject(err);
      resolve('hooo');
    });
  });
};

mood.getSongInfo = function getSongInfo(songs) {
  return auth.getToken().then(function (token) {
    return Promise.all(songs.map(function (song) {
      return Promise.all([auth.callSpotify('https://api.spotify.com/v1/audio-features/' + song, token), auth.callSpotify('https://api.spotify.com/v1/tracks/' + song, token)]).then(function (arr) {
        return _.merge(arr[0], arr[1]);
      }).then(function (combinedInfo) {
        var artistId = combinedInfo.artists[0].id;
        console.log(artistId);
        return auth.callSpotify('https://api.spotify.com/v1/artists/' + artistId, token).then(function (artist) {
          return _.merge(combinedInfo, { genres: artist.genres });
        });
      });
    }));
  });
};

mood.getPlaylist = function getPlaylist(moodsongs) {
  var clusters = process.env['CLUSTERS'] + '/clusters' || 'http://localhost:5000/clusters';

  return mood.getSongInfo(moodsongs).then(function (songs) {
    return request({
      url: clusters,
      method: 'POST',
      body: {
        songs: songs
      },
      json: true
    });
  }).then(function (_ref) {
    var features = _ref.features;
    var artists = _ref.artists;
    return recommender.getSongs(features, artists);
  });
};

firebase.child('moodsongs').on('value', function (snap) {
  var moodsongs = _.values(snap.val());
  console.log('moodsongs', moodsongs);
  mood.onListChange(moodsongs);
});

mood.trimPlaylist = function trimPlaylist(playlist) {
  return playlist.tracks.map(function (track) {
    var start = _.pick(track, ['id', 'name', 'artists', 'duration_ms']);
    start.artist = start.artists.map(function (artist) {
      return artist.name;
    }).join(', ');
    delete start.artists;
    return start;
  });
};

mood.onListChange = function onListChange(moodsongs) {
  mood.getPlaylist(moodsongs).then(function (playlist) {
    var p = mood.trimPlaylist(playlist);
    firebase.child('playlist').set(p);
    firebase.child('pointer').set(p[0]);
  });
};

module.exports = mood;
//# sourceMappingURL=data:application/json;base64,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LENBQVksV0FBWixFQUF5QixTQUF6QjtBQUNBLE9BQUssWUFBTCxDQUFrQixTQUFsQjtBQUNELENBSkQ7O0FBTUEsS0FBSyxZQUFMLEdBQW9CLFNBQVMsWUFBVCxDQUF1QixRQUF2QixFQUFpQztBQUNuRCxTQUFPLFNBQVMsTUFBVCxDQUFnQixHQUFoQixDQUFvQixpQkFBUztBQUNsQyxRQUFJLFFBQVEsRUFBRSxJQUFGLENBQU8sS0FBUCxFQUFjLENBQUMsSUFBRCxFQUFPLE1BQVAsRUFBZSxTQUFmLEVBQTBCLGFBQTFCLENBQWQsQ0FBWjtBQUNBLFVBQU0sTUFBTixHQUFlLE1BQU0sT0FBTixDQUFjLEdBQWQsQ0FBa0I7QUFBQSxhQUFVLE9BQU8sSUFBakI7QUFBQSxLQUFsQixFQUF5QyxJQUF6QyxDQUE4QyxJQUE5QyxDQUFmO0FBQ0EsV0FBTyxNQUFNLE9BQWI7QUFDQSxXQUFPLEtBQVA7QUFDRCxHQUxNLENBQVA7QUFNRCxDQVBEOztBQVNBLEtBQUssWUFBTCxHQUFvQixTQUFTLFlBQVQsQ0FBdUIsU0FBdkIsRUFBa0M7QUFDcEQsT0FBSyxXQUFMLENBQWlCLFNBQWpCLEVBQ0csSUFESCxDQUNRLG9CQUFZO0FBQ2hCLFFBQUksSUFBSSxLQUFLLFlBQUwsQ0FBa0IsUUFBbEIsQ0FBUjtBQUNBLGFBQVMsS0FBVCxDQUFlLFVBQWYsRUFBMkIsR0FBM0IsQ0FBK0IsQ0FBL0I7QUFDQSxhQUFTLEtBQVQsQ0FBZSxTQUFmLEVBQTBCLEdBQTFCLENBQThCLEVBQUUsQ0FBRixDQUE5QjtBQUNELEdBTEg7QUFNRCxDQVBEOztBQVNBLE9BQU8sT0FBUCxHQUFpQixJQUFqQiIsImZpbGUiOiJtb29kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbW9vZFxuY29uc3QgbW9vZCA9IHt9O1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBmaXJlYmFzZSA9IHJlcXVpcmUoJy4vZmlyZWJhc2UnKTtcbnZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG52YXIgYXV0aCA9IHJlcXVpcmUoJy4vYXV0aCcpO1xudmFyIHJlY29tbWVuZGVyID0gcmVxdWlyZSgnLi9yZWNvbW1lbmRlcicpO1xuXG5tb29kLmhhbmRsZXIgPSBmdW5jdGlvbiBtb29kSGFuZGxlciAoc29uZywgdXNlcklkKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgdmFyIGRhdGEgPSB7fTtcbiAgICBkYXRhW3VzZXJJZF0gPSBzb25nLnNvbmdJZDtcbiAgICBmaXJlYmFzZS5jaGlsZCgnbW9vZHNvbmdzJykudXBkYXRlKGRhdGEsIGVyciA9PiB7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcbiAgICAgIHJlc29sdmUoJ2hvb28nKTtcbiAgICB9KVxuICB9KVxufVxuXG5tb29kLmdldFNvbmdJbmZvID0gZnVuY3Rpb24gZ2V0U29uZ0luZm8oc29uZ3MpIHtcbiAgcmV0dXJuIGF1dGguZ2V0VG9rZW4oKVxuICAgIC50aGVuKHRva2VuID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChzb25ncy5tYXAoc29uZyA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgYXV0aC5jYWxsU3BvdGlmeSgnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvYXVkaW8tZmVhdHVyZXMvJyArIHNvbmcsIHRva2VuKSxcbiAgICAgICAgICBhdXRoLmNhbGxTcG90aWZ5KCdodHRwczovL2FwaS5zcG90aWZ5LmNvbS92MS90cmFja3MvJyArIHNvbmcsIHRva2VuKVxuICAgICAgICBdKVxuICAgICAgICAgIC50aGVuKGFyciA9PiBfLm1lcmdlKGFyclswXSwgYXJyWzFdKSlcbiAgICAgICAgICAudGhlbihjb21iaW5lZEluZm8gPT4ge1xuICAgICAgICAgICAgdmFyIGFydGlzdElkID0gY29tYmluZWRJbmZvLmFydGlzdHNbMF0uaWRcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGFydGlzdElkKVxuICAgICAgICAgICAgcmV0dXJuIGF1dGguY2FsbFNwb3RpZnkoJ2h0dHBzOi8vYXBpLnNwb3RpZnkuY29tL3YxL2FydGlzdHMvJyArIGFydGlzdElkLCB0b2tlbilcbiAgICAgICAgICAgICAgLnRoZW4oYXJ0aXN0ID0+IF8ubWVyZ2UoY29tYmluZWRJbmZvLCB7IGdlbnJlczogYXJ0aXN0LmdlbnJlcyB9KSlcbiAgICAgICAgICB9KVxuICAgICAgfSkpXG4gICAgfSlcbn1cblxubW9vZC5nZXRQbGF5bGlzdCA9IGZ1bmN0aW9uIGdldFBsYXlsaXN0KG1vb2Rzb25ncykge1xuICB2YXIgY2x1c3RlcnMgPSBwcm9jZXNzLmVudlsnQ0xVU1RFUlMnXSArICcvY2x1c3RlcnMnIHx8ICdodHRwOi8vbG9jYWxob3N0OjUwMDAvY2x1c3RlcnMnO1xuXG4gIHJldHVybiBtb29kLmdldFNvbmdJbmZvKG1vb2Rzb25ncylcbiAgICAudGhlbihzb25ncyA9PiB7XG4gICAgICByZXR1cm4gcmVxdWVzdCh7XG4gICAgICAgIHVybDogY2x1c3RlcnMsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBib2R5OiB7XG4gICAgICAgICAgc29uZ3M6IHNvbmdzXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH0pXG4gICAgfSlcbiAgICAudGhlbigoe2ZlYXR1cmVzLCBhcnRpc3RzfSkgPT4gcmVjb21tZW5kZXIuZ2V0U29uZ3MoZmVhdHVyZXMsIGFydGlzdHMpKVxufVxuXG5maXJlYmFzZS5jaGlsZCgnbW9vZHNvbmdzJykub24oJ3ZhbHVlJywgc25hcCA9PiB7XG4gIHZhciBtb29kc29uZ3MgPSBfLnZhbHVlcyhzbmFwLnZhbCgpKTtcbiAgY29uc29sZS5sb2coJ21vb2Rzb25ncycsIG1vb2Rzb25ncyk7XG4gIG1vb2Qub25MaXN0Q2hhbmdlKG1vb2Rzb25ncylcbn0pXG5cbm1vb2QudHJpbVBsYXlsaXN0ID0gZnVuY3Rpb24gdHJpbVBsYXlsaXN0IChwbGF5bGlzdCkge1xuICByZXR1cm4gcGxheWxpc3QudHJhY2tzLm1hcCh0cmFjayA9PiB7XG4gICAgdmFyIHN0YXJ0ID0gXy5waWNrKHRyYWNrLCBbJ2lkJywgJ25hbWUnLCAnYXJ0aXN0cycsICdkdXJhdGlvbl9tcyddKTtcbiAgICBzdGFydC5hcnRpc3QgPSBzdGFydC5hcnRpc3RzLm1hcChhcnRpc3QgPT4gYXJ0aXN0Lm5hbWUpLmpvaW4oJywgJyk7XG4gICAgZGVsZXRlIHN0YXJ0LmFydGlzdHM7XG4gICAgcmV0dXJuIHN0YXJ0O1xuICB9KVxufVxuXG5tb29kLm9uTGlzdENoYW5nZSA9IGZ1bmN0aW9uIG9uTGlzdENoYW5nZSAobW9vZHNvbmdzKSB7XG4gIG1vb2QuZ2V0UGxheWxpc3QobW9vZHNvbmdzKVxuICAgIC50aGVuKHBsYXlsaXN0ID0+IHtcbiAgICAgIHZhciBwID0gbW9vZC50cmltUGxheWxpc3QocGxheWxpc3QpXG4gICAgICBmaXJlYmFzZS5jaGlsZCgncGxheWxpc3QnKS5zZXQocClcbiAgICAgIGZpcmViYXNlLmNoaWxkKCdwb2ludGVyJykuc2V0KHBbMF0pXG4gICAgfSlcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBtb29kO1xuIl19