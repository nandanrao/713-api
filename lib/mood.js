'use strict';

// mood
var mood = {};
var _ = require('lodash');
var firebase = require('./firebase');
var request = require('request-promise');
var Promise = require('bluebird');
var auth = require('./auth');
var recommender = require('./recommender');

mood.handler = function moodHandler(song, userId) {
  return new Promise(function (resolve, reject) {
    var data = {};
    data[userId] = song.songId;
    firebase.child('moodsongs').update(data, function (err) {
      if (err) reject(err);
      resolve('hooo');
    });
  });
};

mood.getSongInfo = function getSongInfo(songs) {
  return auth.getToken().then(function (token) {
    return Promise.all(songs.map(function (song) {
      return Promise.all([auth.callSpotify('https://api.spotify.com/v1/audio-features/' + song, token), auth.callSpotify('https://api.spotify.com/v1/tracks/' + song, token)]).then(function (arr) {
        return _.merge(arr[0], arr[1]);
      }).then(function (combinedInfo) {
        var artistId = combinedInfo.artists[0].id;
        return auth.callSpotify('https://api.spotify.com/v1/artists/' + artistId, token).then(function (artist) {
          return _.merge(combinedInfo, { genres: artist.genres });
        });
      });
    }));
  });
};

mood.getPlaylist = function getPlaylist(moodsongs) {
  var clusters = process.env['CLUSTERS'] + '/clusters';

  return mood.getSongInfo(moodsongs).then(function (songs) {
    return request({
      url: clusters,
      method: 'POST',
      body: {
        songs: songs
      },
      json: true
    });
  }).then(function (_ref) {
    var features = _ref.features;
    var artists = _ref.artists;
    return recommender.getSongs(features, artists);
  });
};

firebase.child('moodsongs').on('value', function (snap) {
  var moodsongs = _.values(snap.val());
  mood.onListChange(moodsongs);
});

mood.trimPlaylist = function trimPlaylist(playlist) {
  return playlist.tracks.map(function (track) {
    var start = _.pick(track, ['id', 'name', 'artists', 'duration_ms']);
    start.artist = start.artists.map(function (artist) {
      return artist.name;
    }).join(', ');
    delete start.artists;
    return start;
  });
};

mood.setUserList = function setUserList(userId, userlistId, playlist, token) {
  var list = playlist.map(function (track) {
    return 'spotify:track:' + track.id;
  });

  return auth.callSpotify({
    url: 'https://api.spotify.com/v1/users/' + userId + '/playlists/' + userlistId + '/tracks',
    method: 'PUT',
    body: {
      uris: list
    },
    json: true
  }, token);
};

mood.addPublicList = function addPublicList(user, token) {
  var playlist;

  firebase.child('userlists/' + user.id).once('value', function (snap) {
    if (!snap.val()) {
      auth.callSpotify({
        url: 'https://api.spotify.com/v1/users/' + user.id + '/playlists',
        method: 'POST',
        body: {
          name: 'CPH:713:B',
          public: true
        },
        json: true
      }, token).then(function (_playlist) {
        playlist = _playlist;
        firebase.child('userlists/' + user.id).set(playlist.id);
        firebase.child('playlist').once('value', function (snap) {
          mood.setUserList(user.id, playlist.id, snap.val(), token);
        });
      });
    }
  });
};

firebase.child('playlist').on('value', function (snap) {
  var playlist = snap.val();
  firebase.child('userlists').once('value', function (snap) {
    var userlists = snap.val();
    _.keys(userlists).map(function (userId) {
      var list = userlists[userId];
      firebase.child('tokens/' + userId).once('value', function (snap) {
        var token = snap.val();
        console.log('token from snap ', token, playlist);
        mood.setUserList(userId, list, playlist, token);
      });
    });
  });
});

mood.onListChange = function onListChange(moodsongs) {
  mood.getPlaylist(moodsongs).then(function (playlist) {
    var p = mood.trimPlaylist(playlist);
    console.log('here p');
    firebase.child('playlist').set(p);
    firebase.child('pointer').set(p[0]);
  });
};

module.exports = mood;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb29kLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLElBQU0sT0FBTyxFQUFiO0FBQ0EsSUFBSSxJQUFJLFFBQVEsUUFBUixDQUFSO0FBQ0EsSUFBSSxXQUFXLFFBQVEsWUFBUixDQUFmO0FBQ0EsSUFBSSxVQUFVLFFBQVEsaUJBQVIsQ0FBZDtBQUNBLElBQUksVUFBVSxRQUFRLFVBQVIsQ0FBZDtBQUNBLElBQUksT0FBTyxRQUFRLFFBQVIsQ0FBWDtBQUNBLElBQUksY0FBYyxRQUFRLGVBQVIsQ0FBbEI7O0FBRUEsS0FBSyxPQUFMLEdBQWUsU0FBUyxXQUFULENBQXNCLElBQXRCLEVBQTRCLE1BQTVCLEVBQW9DO0FBQ2pELFNBQU8sSUFBSSxPQUFKLENBQVksVUFBQyxPQUFELEVBQVUsTUFBVixFQUFxQjtBQUN0QyxRQUFJLE9BQU8sRUFBWDtBQUNBLFNBQUssTUFBTCxJQUFlLEtBQUssTUFBcEI7QUFDQSxhQUFTLEtBQVQsQ0FBZSxXQUFmLEVBQTRCLE1BQTVCLENBQW1DLElBQW5DLEVBQXlDLGVBQU87QUFDOUMsVUFBSSxHQUFKLEVBQVMsT0FBTyxHQUFQO0FBQ1QsY0FBUSxNQUFSO0FBQ0QsS0FIRDtBQUlELEdBUE0sQ0FBUDtBQVFELENBVEQ7O0FBV0EsS0FBSyxXQUFMLEdBQW1CLFNBQVMsV0FBVCxDQUFxQixLQUFyQixFQUE0QjtBQUM3QyxTQUFPLEtBQUssUUFBTCxHQUNKLElBREksQ0FDQyxpQkFBUztBQUNiLFdBQU8sUUFBUSxHQUFSLENBQVksTUFBTSxHQUFOLENBQVUsZ0JBQVE7QUFDbkMsYUFBTyxRQUFRLEdBQVIsQ0FBWSxDQUNqQixLQUFLLFdBQUwsQ0FBaUIsK0NBQStDLElBQWhFLEVBQXNFLEtBQXRFLENBRGlCLEVBRWpCLEtBQUssV0FBTCxDQUFpQix1Q0FBdUMsSUFBeEQsRUFBOEQsS0FBOUQsQ0FGaUIsQ0FBWixFQUlKLElBSkksQ0FJQztBQUFBLGVBQU8sRUFBRSxLQUFGLENBQVEsSUFBSSxDQUFKLENBQVIsRUFBZ0IsSUFBSSxDQUFKLENBQWhCLENBQVA7QUFBQSxPQUpELEVBS0osSUFMSSxDQUtDLHdCQUFnQjtBQUNwQixZQUFJLFdBQVcsYUFBYSxPQUFiLENBQXFCLENBQXJCLEVBQXdCLEVBQXZDO0FBQ0EsZUFBTyxLQUFLLFdBQUwsQ0FBaUIsd0NBQXdDLFFBQXpELEVBQW1FLEtBQW5FLEVBQ0osSUFESSxDQUNDO0FBQUEsaUJBQVUsRUFBRSxLQUFGLENBQVEsWUFBUixFQUFzQixFQUFFLFFBQVEsT0FBTyxNQUFqQixFQUF0QixDQUFWO0FBQUEsU0FERCxDQUFQO0FBRUQsT0FUSSxDQUFQO0FBVUQsS0FYa0IsQ0FBWixDQUFQO0FBWUQsR0FkSSxDQUFQO0FBZUQsQ0FoQkQ7O0FBa0JBLEtBQUssV0FBTCxHQUFtQixTQUFTLFdBQVQsQ0FBcUIsU0FBckIsRUFBZ0M7QUFDakQsTUFBSSxXQUFXLFFBQVEsR0FBUixDQUFZLFVBQVosSUFBMEIsV0FBekM7O0FBRUEsU0FBTyxLQUFLLFdBQUwsQ0FBaUIsU0FBakIsRUFDSixJQURJLENBQ0MsaUJBQVM7QUFDYixXQUFPLFFBQVE7QUFDYixXQUFLLFFBRFE7QUFFYixjQUFRLE1BRks7QUFHYixZQUFNO0FBQ0osZUFBTztBQURILE9BSE87QUFNYixZQUFNO0FBTk8sS0FBUixDQUFQO0FBUUQsR0FWSSxFQVdKLElBWEksQ0FXQztBQUFBLFFBQUUsUUFBRixRQUFFLFFBQUY7QUFBQSxRQUFZLE9BQVosUUFBWSxPQUFaO0FBQUEsV0FBeUIsWUFBWSxRQUFaLENBQXFCLFFBQXJCLEVBQStCLE9BQS9CLENBQXpCO0FBQUEsR0FYRCxDQUFQO0FBWUQsQ0FmRDs7QUFpQkEsU0FBUyxLQUFULENBQWUsV0FBZixFQUE0QixFQUE1QixDQUErQixPQUEvQixFQUF3QyxnQkFBUTtBQUM5QyxNQUFJLFlBQVksRUFBRSxNQUFGLENBQVMsS0FBSyxHQUFMLEVBQVQsQ0FBaEI7QUFDQSxPQUFLLFlBQUwsQ0FBa0IsU0FBbEI7QUFDRCxDQUhEOztBQUtBLEtBQUssWUFBTCxHQUFvQixTQUFTLFlBQVQsQ0FBdUIsUUFBdkIsRUFBaUM7QUFDbkQsU0FBTyxTQUFTLE1BQVQsQ0FBZ0IsR0FBaEIsQ0FBb0IsaUJBQVM7QUFDbEMsUUFBSSxRQUFRLEVBQUUsSUFBRixDQUFPLEtBQVAsRUFBYyxDQUFDLElBQUQsRUFBTyxNQUFQLEVBQWUsU0FBZixFQUEwQixhQUExQixDQUFkLENBQVo7QUFDQSxVQUFNLE1BQU4sR0FBZSxNQUFNLE9BQU4sQ0FBYyxHQUFkLENBQWtCO0FBQUEsYUFBVSxPQUFPLElBQWpCO0FBQUEsS0FBbEIsRUFBeUMsSUFBekMsQ0FBOEMsSUFBOUMsQ0FBZjtBQUNBLFdBQU8sTUFBTSxPQUFiO0FBQ0EsV0FBTyxLQUFQO0FBQ0QsR0FMTSxDQUFQO0FBTUQsQ0FQRDs7QUFTQSxLQUFLLFdBQUwsR0FBbUIsU0FBUyxXQUFULENBQXFCLE1BQXJCLEVBQTZCLFVBQTdCLEVBQXlDLFFBQXpDLEVBQW1ELEtBQW5ELEVBQTBEO0FBQzNFLE1BQUksT0FBTyxTQUFTLEdBQVQsQ0FBYTtBQUFBLFdBQVMsbUJBQW1CLE1BQU0sRUFBbEM7QUFBQSxHQUFiLENBQVg7O0FBRUEsU0FBTyxLQUFLLFdBQUwsQ0FBaUI7QUFDdEIsU0FBSyxzQ0FBb0MsTUFBcEMsR0FBMkMsYUFBM0MsR0FBeUQsVUFBekQsR0FBb0UsU0FEbkQ7QUFFdEIsWUFBUSxLQUZjO0FBR3RCLFVBQU07QUFDSixZQUFNO0FBREYsS0FIZ0I7QUFNdEIsVUFBTTtBQU5nQixHQUFqQixFQU9KLEtBUEksQ0FBUDtBQVFELENBWEQ7O0FBYUEsS0FBSyxhQUFMLEdBQXFCLFNBQVMsYUFBVCxDQUF3QixJQUF4QixFQUE4QixLQUE5QixFQUFxQztBQUN4RCxNQUFJLFFBQUo7O0FBRUEsV0FBUyxLQUFULENBQWUsZUFBZSxLQUFLLEVBQW5DLEVBQXVDLElBQXZDLENBQTRDLE9BQTVDLEVBQXFELGdCQUFRO0FBQzNELFFBQUksQ0FBQyxLQUFLLEdBQUwsRUFBTCxFQUFpQjtBQUNmLFdBQUssV0FBTCxDQUFpQjtBQUNmLGFBQUssc0NBQW9DLEtBQUssRUFBekMsR0FBNEMsWUFEbEM7QUFFZixnQkFBUSxNQUZPO0FBR2YsY0FBTTtBQUNKLGdCQUFNLFdBREY7QUFFSixrQkFBUTtBQUZKLFNBSFM7QUFPZixjQUFNO0FBUFMsT0FBakIsRUFRRyxLQVJILEVBU0csSUFUSCxDQVNRLHFCQUFhO0FBQ2pCLG1CQUFXLFNBQVg7QUFDQSxpQkFBUyxLQUFULENBQWUsZUFBZSxLQUFLLEVBQW5DLEVBQXVDLEdBQXZDLENBQTJDLFNBQVMsRUFBcEQ7QUFDQSxpQkFBUyxLQUFULENBQWUsVUFBZixFQUEyQixJQUEzQixDQUFnQyxPQUFoQyxFQUF5QyxnQkFBUTtBQUMvQyxlQUFLLFdBQUwsQ0FBaUIsS0FBSyxFQUF0QixFQUEwQixTQUFTLEVBQW5DLEVBQXVDLEtBQUssR0FBTCxFQUF2QyxFQUFtRCxLQUFuRDtBQUNELFNBRkQ7QUFHRCxPQWZIO0FBZ0JEO0FBQ0YsR0FuQkQ7QUFvQkQsQ0F2QkQ7O0FBeUJBLFNBQVMsS0FBVCxDQUFlLFVBQWYsRUFBMkIsRUFBM0IsQ0FBOEIsT0FBOUIsRUFBdUMsZ0JBQVE7QUFDN0MsTUFBSSxXQUFXLEtBQUssR0FBTCxFQUFmO0FBQ0EsV0FBUyxLQUFULENBQWUsV0FBZixFQUE0QixJQUE1QixDQUFpQyxPQUFqQyxFQUEwQyxnQkFBUTtBQUNoRCxRQUFJLFlBQVksS0FBSyxHQUFMLEVBQWhCO0FBQ0EsTUFBRSxJQUFGLENBQU8sU0FBUCxFQUFrQixHQUFsQixDQUFzQixrQkFBVTtBQUM5QixVQUFJLE9BQU8sVUFBVSxNQUFWLENBQVg7QUFDQSxlQUFTLEtBQVQsQ0FBZSxZQUFZLE1BQTNCLEVBQW1DLElBQW5DLENBQXdDLE9BQXhDLEVBQWlELGdCQUFRO0FBQ3ZELFlBQUksUUFBUSxLQUFLLEdBQUwsRUFBWjtBQUNBLGdCQUFRLEdBQVIsQ0FBWSxrQkFBWixFQUFnQyxLQUFoQyxFQUF1QyxRQUF2QztBQUNBLGFBQUssV0FBTCxDQUFpQixNQUFqQixFQUF5QixJQUF6QixFQUErQixRQUEvQixFQUF5QyxLQUF6QztBQUNELE9BSkQ7QUFLRCxLQVBEO0FBU0QsR0FYRDtBQVlELENBZEQ7O0FBaUJBLEtBQUssWUFBTCxHQUFvQixTQUFTLFlBQVQsQ0FBdUIsU0FBdkIsRUFBa0M7QUFDcEQsT0FBSyxXQUFMLENBQWlCLFNBQWpCLEVBQ0csSUFESCxDQUNRLG9CQUFZO0FBQ2hCLFFBQUksSUFBSSxLQUFLLFlBQUwsQ0FBa0IsUUFBbEIsQ0FBUjtBQUNBLFlBQVEsR0FBUixDQUFZLFFBQVo7QUFDQSxhQUFTLEtBQVQsQ0FBZSxVQUFmLEVBQTJCLEdBQTNCLENBQStCLENBQS9CO0FBQ0EsYUFBUyxLQUFULENBQWUsU0FBZixFQUEwQixHQUExQixDQUE4QixFQUFFLENBQUYsQ0FBOUI7QUFDRCxHQU5IO0FBT0QsQ0FSRDs7QUFVQSxPQUFPLE9BQVAsR0FBaUIsSUFBakIiLCJmaWxlIjoibW9vZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1vb2RcbmNvbnN0IG1vb2QgPSB7fTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgZmlyZWJhc2UgPSByZXF1aXJlKCcuL2ZpcmViYXNlJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZScpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xudmFyIGF1dGggPSByZXF1aXJlKCcuL2F1dGgnKTtcbnZhciByZWNvbW1lbmRlciA9IHJlcXVpcmUoJy4vcmVjb21tZW5kZXInKTtcblxubW9vZC5oYW5kbGVyID0gZnVuY3Rpb24gbW9vZEhhbmRsZXIgKHNvbmcsIHVzZXJJZCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHZhciBkYXRhID0ge307XG4gICAgZGF0YVt1c2VySWRdID0gc29uZy5zb25nSWQ7XG4gICAgZmlyZWJhc2UuY2hpbGQoJ21vb2Rzb25ncycpLnVwZGF0ZShkYXRhLCBlcnIgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKCdob29vJyk7XG4gICAgfSlcbiAgfSlcbn1cblxubW9vZC5nZXRTb25nSW5mbyA9IGZ1bmN0aW9uIGdldFNvbmdJbmZvKHNvbmdzKSB7XG4gIHJldHVybiBhdXRoLmdldFRva2VuKClcbiAgICAudGhlbih0b2tlbiA9PiB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoc29uZ3MubWFwKHNvbmcgPT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIGF1dGguY2FsbFNwb3RpZnkoJ2h0dHBzOi8vYXBpLnNwb3RpZnkuY29tL3YxL2F1ZGlvLWZlYXR1cmVzLycgKyBzb25nLCB0b2tlbiksXG4gICAgICAgICAgYXV0aC5jYWxsU3BvdGlmeSgnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvdHJhY2tzLycgKyBzb25nLCB0b2tlbilcbiAgICAgICAgXSlcbiAgICAgICAgICAudGhlbihhcnIgPT4gXy5tZXJnZShhcnJbMF0sIGFyclsxXSkpXG4gICAgICAgICAgLnRoZW4oY29tYmluZWRJbmZvID0+IHtcbiAgICAgICAgICAgIHZhciBhcnRpc3RJZCA9IGNvbWJpbmVkSW5mby5hcnRpc3RzWzBdLmlkXG4gICAgICAgICAgICByZXR1cm4gYXV0aC5jYWxsU3BvdGlmeSgnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvYXJ0aXN0cy8nICsgYXJ0aXN0SWQsIHRva2VuKVxuICAgICAgICAgICAgICAudGhlbihhcnRpc3QgPT4gXy5tZXJnZShjb21iaW5lZEluZm8sIHsgZ2VucmVzOiBhcnRpc3QuZ2VucmVzIH0pKVxuICAgICAgICAgIH0pXG4gICAgICB9KSlcbiAgICB9KVxufVxuXG5tb29kLmdldFBsYXlsaXN0ID0gZnVuY3Rpb24gZ2V0UGxheWxpc3QobW9vZHNvbmdzKSB7XG4gIHZhciBjbHVzdGVycyA9IHByb2Nlc3MuZW52WydDTFVTVEVSUyddICsgJy9jbHVzdGVycyc7XG5cbiAgcmV0dXJuIG1vb2QuZ2V0U29uZ0luZm8obW9vZHNvbmdzKVxuICAgIC50aGVuKHNvbmdzID0+IHtcbiAgICAgIHJldHVybiByZXF1ZXN0KHtcbiAgICAgICAgdXJsOiBjbHVzdGVycyxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGJvZHk6IHtcbiAgICAgICAgICBzb25nczogc29uZ3NcbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfSlcbiAgICB9KVxuICAgIC50aGVuKCh7ZmVhdHVyZXMsIGFydGlzdHN9KSA9PiByZWNvbW1lbmRlci5nZXRTb25ncyhmZWF0dXJlcywgYXJ0aXN0cykpXG59XG5cbmZpcmViYXNlLmNoaWxkKCdtb29kc29uZ3MnKS5vbigndmFsdWUnLCBzbmFwID0+IHtcbiAgdmFyIG1vb2Rzb25ncyA9IF8udmFsdWVzKHNuYXAudmFsKCkpO1xuICBtb29kLm9uTGlzdENoYW5nZShtb29kc29uZ3MpXG59KVxuXG5tb29kLnRyaW1QbGF5bGlzdCA9IGZ1bmN0aW9uIHRyaW1QbGF5bGlzdCAocGxheWxpc3QpIHtcbiAgcmV0dXJuIHBsYXlsaXN0LnRyYWNrcy5tYXAodHJhY2sgPT4ge1xuICAgIHZhciBzdGFydCA9IF8ucGljayh0cmFjaywgWydpZCcsICduYW1lJywgJ2FydGlzdHMnLCAnZHVyYXRpb25fbXMnXSk7XG4gICAgc3RhcnQuYXJ0aXN0ID0gc3RhcnQuYXJ0aXN0cy5tYXAoYXJ0aXN0ID0+IGFydGlzdC5uYW1lKS5qb2luKCcsICcpO1xuICAgIGRlbGV0ZSBzdGFydC5hcnRpc3RzO1xuICAgIHJldHVybiBzdGFydDtcbiAgfSlcbn1cblxubW9vZC5zZXRVc2VyTGlzdCA9IGZ1bmN0aW9uIHNldFVzZXJMaXN0KHVzZXJJZCwgdXNlcmxpc3RJZCwgcGxheWxpc3QsIHRva2VuKSB7XG4gIHZhciBsaXN0ID0gcGxheWxpc3QubWFwKHRyYWNrID0+ICdzcG90aWZ5OnRyYWNrOicgKyB0cmFjay5pZCk7XG5cbiAgcmV0dXJuIGF1dGguY2FsbFNwb3RpZnkoe1xuICAgIHVybDogJ2h0dHBzOi8vYXBpLnNwb3RpZnkuY29tL3YxL3VzZXJzLycrdXNlcklkKycvcGxheWxpc3RzLycrdXNlcmxpc3RJZCsnL3RyYWNrcycsXG4gICAgbWV0aG9kOiAnUFVUJyxcbiAgICBib2R5OiB7XG4gICAgICB1cmlzOiBsaXN0XG4gICAgfSxcbiAgICBqc29uOiB0cnVlXG4gIH0sIHRva2VuKVxufVxuXG5tb29kLmFkZFB1YmxpY0xpc3QgPSBmdW5jdGlvbiBhZGRQdWJsaWNMaXN0ICh1c2VyLCB0b2tlbikge1xuICB2YXIgcGxheWxpc3Q7XG5cbiAgZmlyZWJhc2UuY2hpbGQoJ3VzZXJsaXN0cy8nICsgdXNlci5pZCkub25jZSgndmFsdWUnLCBzbmFwID0+IHtcbiAgICBpZiAoIXNuYXAudmFsKCkpIHtcbiAgICAgIGF1dGguY2FsbFNwb3RpZnkoe1xuICAgICAgICB1cmw6ICdodHRwczovL2FwaS5zcG90aWZ5LmNvbS92MS91c2Vycy8nK3VzZXIuaWQrJy9wbGF5bGlzdHMnLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgYm9keToge1xuICAgICAgICAgIG5hbWU6ICdDUEg6NzEzOkInLFxuICAgICAgICAgIHB1YmxpYzogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9LCB0b2tlbilcbiAgICAgICAgLnRoZW4oX3BsYXlsaXN0ID0+IHtcbiAgICAgICAgICBwbGF5bGlzdCA9IF9wbGF5bGlzdDtcbiAgICAgICAgICBmaXJlYmFzZS5jaGlsZCgndXNlcmxpc3RzLycgKyB1c2VyLmlkKS5zZXQocGxheWxpc3QuaWQpO1xuICAgICAgICAgIGZpcmViYXNlLmNoaWxkKCdwbGF5bGlzdCcpLm9uY2UoJ3ZhbHVlJywgc25hcCA9PiB7XG4gICAgICAgICAgICBtb29kLnNldFVzZXJMaXN0KHVzZXIuaWQsIHBsYXlsaXN0LmlkLCBzbmFwLnZhbCgpLCB0b2tlbik7XG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG4gIH0pO1xufVxuXG5maXJlYmFzZS5jaGlsZCgncGxheWxpc3QnKS5vbigndmFsdWUnLCBzbmFwID0+IHtcbiAgdmFyIHBsYXlsaXN0ID0gc25hcC52YWwoKTtcbiAgZmlyZWJhc2UuY2hpbGQoJ3VzZXJsaXN0cycpLm9uY2UoJ3ZhbHVlJywgc25hcCA9PiB7XG4gICAgdmFyIHVzZXJsaXN0cyA9IHNuYXAudmFsKCk7XG4gICAgXy5rZXlzKHVzZXJsaXN0cykubWFwKHVzZXJJZCA9PiB7XG4gICAgICB2YXIgbGlzdCA9IHVzZXJsaXN0c1t1c2VySWRdO1xuICAgICAgZmlyZWJhc2UuY2hpbGQoJ3Rva2Vucy8nICsgdXNlcklkKS5vbmNlKCd2YWx1ZScsIHNuYXAgPT4ge1xuICAgICAgICB2YXIgdG9rZW4gPSBzbmFwLnZhbCgpO1xuICAgICAgICBjb25zb2xlLmxvZygndG9rZW4gZnJvbSBzbmFwICcsIHRva2VuLCBwbGF5bGlzdClcbiAgICAgICAgbW9vZC5zZXRVc2VyTGlzdCh1c2VySWQsIGxpc3QsIHBsYXlsaXN0LCB0b2tlbilcbiAgICAgIH0pXG4gICAgfSk7XG5cbiAgfSk7XG59KVxuXG5cbm1vb2Qub25MaXN0Q2hhbmdlID0gZnVuY3Rpb24gb25MaXN0Q2hhbmdlIChtb29kc29uZ3MpIHtcbiAgbW9vZC5nZXRQbGF5bGlzdChtb29kc29uZ3MpXG4gICAgLnRoZW4ocGxheWxpc3QgPT4ge1xuICAgICAgdmFyIHAgPSBtb29kLnRyaW1QbGF5bGlzdChwbGF5bGlzdClcbiAgICAgIGNvbnNvbGUubG9nKCdoZXJlIHAnKVxuICAgICAgZmlyZWJhc2UuY2hpbGQoJ3BsYXlsaXN0Jykuc2V0KHApXG4gICAgICBmaXJlYmFzZS5jaGlsZCgncG9pbnRlcicpLnNldChwWzBdKVxuICAgIH0pXG59XG5cbm1vZHVsZS5leHBvcnRzID0gbW9vZDtcbiJdfQ==