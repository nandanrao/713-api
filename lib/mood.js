'use strict';

// mood
var mood = {};
var _ = require('lodash');
var firebase = require('./firebase');
var request = require('request-promise');
var Promise = require('bluebird');
var auth = require('./auth');
var recommender = require('./recommender');

mood.handler = function moodHandler(song, userId) {
  return new Promise(function (resolve, reject) {
    var data = {};
    data[userId] = song.songId;
    firebase.child('moodsongs').update(data, function (err) {
      if (err) reject(err);
      resolve('hooo');
    });
  });
};

mood.getSongInfo = function getSongInfo(songs) {
  return auth.getToken().then(function (token) {
    return Promise.all(songs.map(function (song) {
      return Promise.all([auth.callSpotify('https://api.spotify.com/v1/audio-features/' + song, token), auth.callSpotify('https://api.spotify.com/v1/tracks/' + song, token)]).then(function (arr) {
        return _.merge(arr[0], arr[1]);
      }).then(function (combinedInfo) {
        var artistId = combinedInfo.artists[0].id;
        return auth.callSpotify('https://api.spotify.com/v1/artists/' + artistId, token).then(function (artist) {
          return _.merge(combinedInfo, { genres: artist.genres });
        });
      });
    }));
  });
};

mood.getPlaylist = function getPlaylist(moodsongs) {
  var clusters = process.env['CLUSTERS'] + '/clusters';

  return mood.getSongInfo(moodsongs).then(function (songs) {
    return request({
      url: clusters,
      method: 'POST',
      body: {
        songs: songs
      },
      json: true
    });
  }).then(function (_ref) {
    var features = _ref.features;
    var artists = _ref.artists;
    return recommender.getSongs(features, artists);
  });
};

firebase.child('moodsongs').on('value', function (snap) {
  var moodsongs = _.values(snap.val());
  mood.onListChange(moodsongs);
});

mood.trimPlaylist = function trimPlaylist(playlist) {
  return playlist.tracks.map(function (track) {
    var start = _.pick(track, ['id', 'name', 'artists', 'duration_ms']);
    start.artist = start.artists.map(function (artist) {
      return artist.name;
    }).join(', ');
    delete start.artists;
    return start;
  });
};

mood.setUserList = function setUserList(userId, userlistId, playlist, token) {
  var list = playlist.map(function (track) {
    return 'spotify:track:' + track.id;
  });

  return auth.callSpotify({
    url: 'https://api.spotify.com/v1/users/' + userId + '/playlists/' + userlistId + '/tracks',
    method: 'PUT',
    body: {
      uris: list
    },
    json: true
  }, token);
};

mood.addPublicList = function addPublicList(user, token) {
  var playlist;

  firebase.child('userlists/' + user.id).once('value', function (snap) {
    if (!snap.val()) {
      auth.callSpotify({
        url: 'https://api.spotify.com/v1/users/' + user.id + '/playlists',
        method: 'POST',
        body: {
          name: 'CPH:713',
          public: false
        },
        json: true
      }, token).then(function (_playlist) {
        playlist = _playlist;
        firebase.child('userlists/' + user.id).set(playlist.id);
        firebase.child('playlist').once('value', function (snap) {
          mood.setUserList(user.id, playlist.id, snap.val(), token);
        });
      });
    }
  });
};

firebase.child('playlist').on('value', function (snap) {
  var playlist = snap.val();
  firebase.child('userlists').once('value', function (snap) {
    var userlists = snap.val();
    _.keys(userlists).map(function (userId) {
      var list = userlists[userId];
      firebase.child('tokens/' + userId).once('value', function (snap) {
        var token = snap.val();
        console.log('token from snap ', token);
        mood.setUserList(userId, list, playlist, token);
      });
    });
  });
});

mood.onListChange = function onListChange(moodsongs) {
  mood.getPlaylist(moodsongs).then(function (playlist) {
    var p = mood.trimPlaylist(playlist);
    firebase.child('playlist').set(p);
    firebase.child('pointer').set(p[0]);
  });
};

module.exports = mood;
//# sourceMappingURL=data:application/json;base64,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QUFLRCxLQVBEO0FBU0QsR0FYRDtBQVlELENBZEQ7O0FBcUJBLEtBQUssWUFBTCxHQUFvQixTQUFTLFlBQVQsQ0FBdUIsU0FBdkIsRUFBa0M7QUFDcEQsT0FBSyxXQUFMLENBQWlCLFNBQWpCLEVBQ0csSUFESCxDQUNRLG9CQUFZO0FBQ2hCLFFBQUksSUFBSSxLQUFLLFlBQUwsQ0FBa0IsUUFBbEIsQ0FBUjtBQUNBLGFBQVMsS0FBVCxDQUFlLFVBQWYsRUFBMkIsR0FBM0IsQ0FBK0IsQ0FBL0I7QUFDQSxhQUFTLEtBQVQsQ0FBZSxTQUFmLEVBQTBCLEdBQTFCLENBQThCLEVBQUUsQ0FBRixDQUE5QjtBQUNELEdBTEg7QUFNRCxDQVBEOztBQVNBLE9BQU8sT0FBUCxHQUFpQixJQUFqQiIsImZpbGUiOiJtb29kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbW9vZFxuY29uc3QgbW9vZCA9IHt9O1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBmaXJlYmFzZSA9IHJlcXVpcmUoJy4vZmlyZWJhc2UnKTtcbnZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG52YXIgYXV0aCA9IHJlcXVpcmUoJy4vYXV0aCcpO1xudmFyIHJlY29tbWVuZGVyID0gcmVxdWlyZSgnLi9yZWNvbW1lbmRlcicpO1xuXG5tb29kLmhhbmRsZXIgPSBmdW5jdGlvbiBtb29kSGFuZGxlciAoc29uZywgdXNlcklkKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgdmFyIGRhdGEgPSB7fTtcbiAgICBkYXRhW3VzZXJJZF0gPSBzb25nLnNvbmdJZDtcbiAgICBmaXJlYmFzZS5jaGlsZCgnbW9vZHNvbmdzJykudXBkYXRlKGRhdGEsIGVyciA9PiB7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcbiAgICAgIHJlc29sdmUoJ2hvb28nKTtcbiAgICB9KVxuICB9KVxufVxuXG5tb29kLmdldFNvbmdJbmZvID0gZnVuY3Rpb24gZ2V0U29uZ0luZm8oc29uZ3MpIHtcbiAgcmV0dXJuIGF1dGguZ2V0VG9rZW4oKVxuICAgIC50aGVuKHRva2VuID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChzb25ncy5tYXAoc29uZyA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgYXV0aC5jYWxsU3BvdGlmeSgnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvYXVkaW8tZmVhdHVyZXMvJyArIHNvbmcsIHRva2VuKSxcbiAgICAgICAgICBhdXRoLmNhbGxTcG90aWZ5KCdodHRwczovL2FwaS5zcG90aWZ5LmNvbS92MS90cmFja3MvJyArIHNvbmcsIHRva2VuKVxuICAgICAgICBdKVxuICAgICAgICAgIC50aGVuKGFyciA9PiBfLm1lcmdlKGFyclswXSwgYXJyWzFdKSlcbiAgICAgICAgICAudGhlbihjb21iaW5lZEluZm8gPT4ge1xuICAgICAgICAgICAgdmFyIGFydGlzdElkID0gY29tYmluZWRJbmZvLmFydGlzdHNbMF0uaWRcbiAgICAgICAgICAgIHJldHVybiBhdXRoLmNhbGxTcG90aWZ5KCdodHRwczovL2FwaS5zcG90aWZ5LmNvbS92MS9hcnRpc3RzLycgKyBhcnRpc3RJZCwgdG9rZW4pXG4gICAgICAgICAgICAgIC50aGVuKGFydGlzdCA9PiBfLm1lcmdlKGNvbWJpbmVkSW5mbywgeyBnZW5yZXM6IGFydGlzdC5nZW5yZXMgfSkpXG4gICAgICAgICAgfSlcbiAgICAgIH0pKVxuICAgIH0pXG59XG5cbm1vb2QuZ2V0UGxheWxpc3QgPSBmdW5jdGlvbiBnZXRQbGF5bGlzdChtb29kc29uZ3MpIHtcbiAgdmFyIGNsdXN0ZXJzID0gcHJvY2Vzcy5lbnZbJ0NMVVNURVJTJ10gKyAnL2NsdXN0ZXJzJztcblxuICByZXR1cm4gbW9vZC5nZXRTb25nSW5mbyhtb29kc29uZ3MpXG4gICAgLnRoZW4oc29uZ3MgPT4ge1xuICAgICAgcmV0dXJuIHJlcXVlc3Qoe1xuICAgICAgICB1cmw6IGNsdXN0ZXJzLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgYm9keToge1xuICAgICAgICAgIHNvbmdzOiBzb25nc1xuICAgICAgICB9LFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9KVxuICAgIH0pXG4gICAgLnRoZW4oKHtmZWF0dXJlcywgYXJ0aXN0c30pID0+IHJlY29tbWVuZGVyLmdldFNvbmdzKGZlYXR1cmVzLCBhcnRpc3RzKSlcbn1cblxuZmlyZWJhc2UuY2hpbGQoJ21vb2Rzb25ncycpLm9uKCd2YWx1ZScsIHNuYXAgPT4ge1xuICB2YXIgbW9vZHNvbmdzID0gXy52YWx1ZXMoc25hcC52YWwoKSk7XG4gIG1vb2Qub25MaXN0Q2hhbmdlKG1vb2Rzb25ncylcbn0pXG5cbm1vb2QudHJpbVBsYXlsaXN0ID0gZnVuY3Rpb24gdHJpbVBsYXlsaXN0IChwbGF5bGlzdCkge1xuICByZXR1cm4gcGxheWxpc3QudHJhY2tzLm1hcCh0cmFjayA9PiB7XG4gICAgdmFyIHN0YXJ0ID0gXy5waWNrKHRyYWNrLCBbJ2lkJywgJ25hbWUnLCAnYXJ0aXN0cycsICdkdXJhdGlvbl9tcyddKTtcbiAgICBzdGFydC5hcnRpc3QgPSBzdGFydC5hcnRpc3RzLm1hcChhcnRpc3QgPT4gYXJ0aXN0Lm5hbWUpLmpvaW4oJywgJyk7XG4gICAgZGVsZXRlIHN0YXJ0LmFydGlzdHM7XG4gICAgcmV0dXJuIHN0YXJ0O1xuICB9KVxufVxuXG5tb29kLnNldFVzZXJMaXN0ID0gZnVuY3Rpb24gc2V0VXNlckxpc3QodXNlcklkLCB1c2VybGlzdElkLCBwbGF5bGlzdCwgdG9rZW4pIHtcbiAgdmFyIGxpc3QgPSBwbGF5bGlzdC5tYXAodHJhY2sgPT4gJ3Nwb3RpZnk6dHJhY2s6JyArIHRyYWNrLmlkKTtcblxuICByZXR1cm4gYXV0aC5jYWxsU3BvdGlmeSh7XG4gICAgdXJsOiAnaHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjEvdXNlcnMvJyt1c2VySWQrJy9wbGF5bGlzdHMvJyt1c2VybGlzdElkKycvdHJhY2tzJyxcbiAgICBtZXRob2Q6ICdQVVQnLFxuICAgIGJvZHk6IHtcbiAgICAgIHVyaXM6IGxpc3RcbiAgICB9LFxuICAgIGpzb246IHRydWVcbiAgfSwgdG9rZW4pXG59XG5cbm1vb2QuYWRkUHVibGljTGlzdCA9IGZ1bmN0aW9uIGFkZFB1YmxpY0xpc3QgKHVzZXIsIHRva2VuKSB7XG4gIHZhciBwbGF5bGlzdDtcblxuICBmaXJlYmFzZS5jaGlsZCgndXNlcmxpc3RzLycgKyB1c2VyLmlkKS5vbmNlKCd2YWx1ZScsIHNuYXAgPT4ge1xuICAgIGlmICghc25hcC52YWwoKSkge1xuICAgICAgYXV0aC5jYWxsU3BvdGlmeSh7XG4gICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLnNwb3RpZnkuY29tL3YxL3VzZXJzLycrdXNlci5pZCsnL3BsYXlsaXN0cycsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBib2R5OiB7XG4gICAgICAgICAgbmFtZTogJ0NQSDo3MTMnLFxuICAgICAgICAgIHB1YmxpYzogZmFsc2VcbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfSwgdG9rZW4pXG4gICAgICAgIC50aGVuKF9wbGF5bGlzdCA9PiB7XG4gICAgICAgICAgcGxheWxpc3QgPSBfcGxheWxpc3Q7XG4gICAgICAgICAgZmlyZWJhc2UuY2hpbGQoJ3VzZXJsaXN0cy8nICsgdXNlci5pZCkuc2V0KHBsYXlsaXN0LmlkKTtcbiAgICAgICAgICBmaXJlYmFzZS5jaGlsZCgncGxheWxpc3QnKS5vbmNlKCd2YWx1ZScsIHNuYXAgPT4ge1xuICAgICAgICAgICAgbW9vZC5zZXRVc2VyTGlzdCh1c2VyLmlkLCBwbGF5bGlzdC5pZCwgc25hcC52YWwoKSwgdG9rZW4pO1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICB9KTtcbn1cblxuZmlyZWJhc2UuY2hpbGQoJ3BsYXlsaXN0Jykub24oJ3ZhbHVlJywgc25hcCA9PiB7XG4gIHZhciBwbGF5bGlzdCA9IHNuYXAudmFsKCk7XG4gIGZpcmViYXNlLmNoaWxkKCd1c2VybGlzdHMnKS5vbmNlKCd2YWx1ZScsIHNuYXAgPT4ge1xuICAgIHZhciB1c2VybGlzdHMgPSBzbmFwLnZhbCgpO1xuICAgIF8ua2V5cyh1c2VybGlzdHMpLm1hcCh1c2VySWQgPT4ge1xuICAgICAgdmFyIGxpc3QgPSB1c2VybGlzdHNbdXNlcklkXTtcbiAgICAgIGZpcmViYXNlLmNoaWxkKCd0b2tlbnMvJyArIHVzZXJJZCkub25jZSgndmFsdWUnLCBzbmFwID0+IHtcbiAgICAgICAgdmFyIHRva2VuID0gc25hcC52YWwoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3Rva2VuIGZyb20gc25hcCAnLCB0b2tlbilcbiAgICAgICAgbW9vZC5zZXRVc2VyTGlzdCh1c2VySWQsIGxpc3QsIHBsYXlsaXN0LCB0b2tlbilcbiAgICAgIH0pXG4gICAgfSk7XG5cbiAgfSk7XG59KVxuXG5cblxuXG5cblxubW9vZC5vbkxpc3RDaGFuZ2UgPSBmdW5jdGlvbiBvbkxpc3RDaGFuZ2UgKG1vb2Rzb25ncykge1xuICBtb29kLmdldFBsYXlsaXN0KG1vb2Rzb25ncylcbiAgICAudGhlbihwbGF5bGlzdCA9PiB7XG4gICAgICB2YXIgcCA9IG1vb2QudHJpbVBsYXlsaXN0KHBsYXlsaXN0KVxuICAgICAgZmlyZWJhc2UuY2hpbGQoJ3BsYXlsaXN0Jykuc2V0KHApXG4gICAgICBmaXJlYmFzZS5jaGlsZCgncG9pbnRlcicpLnNldChwWzBdKVxuICAgIH0pXG59XG5cbm1vZHVsZS5leHBvcnRzID0gbW9vZDtcbiJdfQ==